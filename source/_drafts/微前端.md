---
title: 微前端
catalog: true
date: 2019-10-22 21:04:32
subtitle:
header-img:
tags: javascript
categories: 前端
---

## 微前端

“ 微前端 ”一词最早于2016年底提出。它将微服务的概念扩展到前端世界。当前的趋势是构建一个功能强大的浏览器应用程序（又名单页应用程序），该应用程序位于微服务架构之上。随着时间的流逝，通常由独立团队开发的前端层会不断增长，并且变得更加难以维护，这就是我们所说的 Frontend Monolith（巨石前端）。

Micro Frontends背后的想法是将网站或Web应用程序视为由独立团队拥有的功能的组合。每个团队都有自己关心和专长的不同业务或任务领域。一个团队具有跨职能，并且从数据库到用户界面，端到端地开发其功能。

## 背景

一般来说，有以下需求的项目可以考虑使用微前端

1. 技术栈的升级/有使用不同技术栈的需求

    目前主流的技术栈，随着技术的发展，必然会持续不断地迭代前端的技术体系，同时也要兼容老项目运行。

    采用微服务的架构，很重要的一点，是解决遗留系统，在不需要重写原有项目的基础下，可以使用新的技术。

2. 巨石应用的维护困难

   - 多年迭代的老项目，不能下线也没资源迁移；
   - 超大的SPA项目，比如中台，动辄几十甚至几百+的页面数量；

    上述情况，让这些系统越来越难维护，开发上，一次启动、编译耗时过长，发布上，同样需要再次经历编译打包过长的困扰，导致开发体验极其糟糕。

3. 系统之间的模块组合与复用

    我们可以通过复制代码去做模块复用，当然这样的结果是难以维护的。
    如果将业务模块封装成包，然后以发布npm包的方式或子仓库git submodule来复用，理论上是可以的。
    但现实是无法处理频繁地需求迭代，每次迭代需要将用到此类模块的项目逐个更新依赖、构建、部署，这样的效率是无法接受的，也容易出出错。

4. 多团队合作开发困难

    出于某些原因，我们会将一个应用拆分为多个功能模块，跨部门多团队来共同完成开发。

    多团队合作的问题不言而喻

    - 代码冲突
    - 模块之间没有隔离，容易相互影响

    很明显看到在处理项目跨度长、多团队合作时，具有强烈需求。那么，典型的场景，就是各大公司企业级的ToB项目以及云产品等。

## 特点

- 技术栈无关

    主框架不限制接入应用的技术栈，微应用具备完全自主权

- 独立开发、独立部署

    应用独立，独立仓库，多团队可独立开发测试部署，部署后主框架自动完成同步更新

- 增量升级

    对遗留项目做技术栈升级或重构，微前端是一种非常好的渐进式重构的手段和策略

- 独立运行

    每个微应用之间状态隔离，运行时状态不可共享

## 实现微前端的方式

1. iframe

    不考虑用户体验以及一些特定case场景，算是比较完美的微前端解决方案；

2. 路由分发

    通过反代、MPA方式处理跳转不同入口文件，多个独立spa应用之间互相跳转，将页面导航做成类似样式，让用户感觉像是在同一应用。

3. 基座式SPA，主从应用设计

    是一种通过*软件工程*的方式在构建前、构建时、构建后等步骤中，对应用进行一步的拆分并重新组合的方式。
这里的基座就是主应用，会包含应用依赖的绝大多数环境，包括基础框架、组件和第三方依赖包，子应用只包含自身一些业务代码。主应用启动后，会捕获全局的路由事件，来判断当前路由需要加载哪个子应用，其中路由要由主应用来接管控制，子应用更像主应用的*路由模块*。

4. 类Single-SPA

    主应用仅作为加载容器，管理子应用的生命周期。路由部分和基座式SPA方式不一样，子应用加载后一般会由子应用去接管系统路由，而基座式的路由完全由主应用控制

5. 组件化（Web Components）

    主要利用Web Components的一些特性

    - Custom elements
    - Shadow DOM
    - HTML templates
    - HTML Imports

每个组件由link标签引入

```html
<link rel="import" href="components/di-li.html">
<link rel="import" href="components/d-header.html">
```

方案 | 优点 | 缺点
- | - | -
MPA + 路由分发 | 框架无关<br>100%隔离<br>独立开发、部署、运行  | 模块复用困难<br>每个独立的spa应用加载时间较长，容易出现白屏，影响体验<br>后续扩展同屏多应用不利于扩展
组件化 |框架无关 |重写现有的前端应用<br>上下游生态系统不完善<br>兼容性
基座式SPA | 打包后的子应用只包含业务代码，体积小，加载快，体验好 | 基座决定了与框架强相关，哪怕是基座版本升级迭代，也会非常容易造成子应用出错<br>对开发、构建方式的*规范*依赖有强烈要求
类Single-SPA | 框架无关<br>独立开发、部署、运行<br>方便复用<br>扩展方便 | 需要子应用入口和配置项有轻微入侵

## 为什么不是iframe

为什么不用iframe，这几乎是所有微前端方案第一个会被追问的问题。但是大部分微前端又不约而同的放弃了iframe的方案，这自然是有一定原因的。

如果不考虑体验问题，iframe几乎是最完美的微前端解决方案了。

iframe 最大的特性就是提供了浏览器原生的硬隔离方案，不论是样式隔离、js 隔离这类问题统统都能被完美解决。但他的最大问题也在于他的隔离性无法被突破，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。

下面列举几个iframe的问题：

1. url不同步。浏览器刷新、前进后退会导致url状态丢失；
2. UI。想象下子iframe窗口大小限制，需要全局展示全局弹窗，提示等；
3. 全局上下文完全隔离，内存变量不共享。iframe 内外系统的通信、数据同步、应用管理等需求处理；
4. 加载慢。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程；

## 各厂分析实现

由于微前端兴起并不久，市面上并没有统一的做法，实现效果、实现方式千差万别。就拿“是否支持不同技术栈”来说，阿里的 qiankun 视之为微服务的核心价值，而 爱奇艺 和 ThoughtWorks 的 mooa 实现中压根就不考虑支持不同技术。

### 爱奇艺技术产品团队

目标

- 框架与业务更加的解耦
- 模块的独立部署、发布等提高迭代效率

效果

- [x] 独立部署  
- [ ] 独立技术栈：仅支持 vue
- [ ] tree shake：手动将 Vue，Router，store，RenderPage 写到全局资源，通用模块注册为懒加载组件
- [x]
- [ ] 多个应用同时运行：同时只能运行一个
- [ ] 公用依赖：否
- [ ] 依赖冲突：否

实现/特点

- 应用资源：每个应用自己打包生成 manifest，标注资源地址
- 路由：统一使用全局路由，子模块的路由加载时合并入全局路由
- 渲染页面：document.head 中插入 script，再主动调用 window.mp.render_home(‘#containerId’)来渲染页面

只支持同一版本的vue，定制化程度非常高的方案，优点是相对简单，缺点是用处不大

### 美团 用微前端的方式搭建单页应用

目标

- 合并多个业务成一个

效果

- [ ] 独立开发：需要奖容器和全部微服务一起启动
- [x] 独立部署
- [ ] 独立技术栈：
- [ ] tree shake：
- [x] 环境隔离：
- [ ] 多个应用同时运行：同时只能运行一个
- [ ] 公用依赖：否
- [ ] 依赖冲突：否

实现/特点

- 容器提供了额外的功能 *用户登录机制* 菜单权限获取 *全局异常处理* 全局数据打点
- 路由由三部分组成权限菜单树、导航和路由树

### 阿里 qiankun开源方案

目标

- 简单，像接入 iframe 一样容易
- 技术栈无关

效果

- [x] 独立开发：容器和业务无耦合，可以随意启动
- [x] 独立部署
- [x] 独立技术栈
- [ ] tree shake：无
- [x] 环境隔离：可选沙盒模式
- [x] 多个应用同时运行：可选支持模式
- [ ] 公用依赖：否
- [ ] 依赖冲突：否

![qiankun](https://segmentfault.com/img/remote/1460000022275996)

流程图

[![qiankun流程图](https://s1.ax1x.com/2020/10/29/BJ18qP.png)](https://imgchr.com/i/BJ18qP)

注意点

- 加载本地资源需要更改子应用配置，携带上当前域名
- 因使用fetch直接加载js，故暂不支持type=module的js，间接不支持vite

## 参考

1. [微前端的那些事儿](https://microfrontends.cn/)
2. [可能是你见过最完善的微前端解决方案](https://zhuanlan.zhihu.com/p/78362028) - 知乎ID: kuitos
3. [Bifrost微前端框架及其在美团闪购中的实践](https://mp.weixin.qq.com/s/GgVo5KyZPlEsEeICcPyuLA) - 美团技术团队（基座式vue）
4. [用微前端的方式搭建类单页应用](https://mp.weixin.qq.com/s/DpFXTrQ3_kBX4EB6or4Q8Q) - 美团技术团队（基座式react）
5. [爱奇艺号如何基于Vue定制开发微前端框架？](https://mp.weixin.qq.com/s/z3Ir-RnPQGXGRh6pDTu8IA) - 爱奇艺号（基座式vue）
