---
title: 微信封禁自动监控技术调研
catalog: true
subtitle:
header-img: 
tags: deep
categories: 前端
---

## 背景

微信基于内部策略和管理，会对通过微信渠道分享的链接进行封禁。目前没有一个现成的服务可以实时并自动监控当前链接在微信中的是否被封状态。

对于有一个自动监控链接是否被封的服务并且及时发送消息就非常重要了。

## 需要实现的技术点

- 需要一个检测微信是否被封的能力【核心技术点】
- 轮询查询这个接口
- 若发现异常，接入消息通知机制【调研企业微信消息接入机制】
  
## 现有的收费的检测微信是否被封的能力的api

- <https://safe.ft12.com/safe.php?url=safe>     <https://www.ft12.com/safe.html>
- <http://www.monkeyapi.com/>   猴子数据付费  每天只有10次机会  根据ip检测
- <http://api.70api.com/api/wx-urlck/?apiKey=2744c44452c5a95d12b3416aa5d59387&url=http://baidu.com>   【有调用总次数限制】

## 自行实现  检测微信是否被封的能力的api 方案调研

企业公众号 有长链转换短链 接口，通过这个接口生成的短链 打开结果进行判断  【亲测可用】【正式企业号 有该接口调用权限，需要企业微信号并且需要300元开通费】

可以用测试账号，每天1000次的调用机会。基本可以满足2min一次的轮询查询

机器人模拟打开，模拟抓包或者模拟识图 【成本比较大】

appium 模拟微信环境webview 打开某页面的情况。抓包分析【难度较大，且需要一个实体机时刻提供代理】

## 使用企业公众号转短链 大致实现流程

1. 申请测试账号，获取测试账号的appid和 secret    <https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index>

2. 根据测试账号 appid和secret 获取token <https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html>
获取token 后 根据 token 调用 长链转短链 接口 <https://developers.weixin.qq.com/doc/offiaccount/Account_Management/URL_Shortener.html>

3. 转成短链后 请求 若被封会 302重定向到weixin110，若没有被封则location是正常的了链接

[![被封的链接](https://s3.ax1x.com/2020/11/24/DN8fPg.png)](https://imgchr.com/i/DN8fPg)

[![正常重定向链接](https://s3.ax1x.com/2020/11/24/DN8RIS.png)](https://imgchr.com/i/DN8RIS)

根据一定的时间间隔轮询短链的打开情况
若检测到location到weixin110 接入企业微信消息通知机制。发送链接被封警告消息

## 可参考实现

<https://www.zhihu.com/question/42101054/answer/860915504>
