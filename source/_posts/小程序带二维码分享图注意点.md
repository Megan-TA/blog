---
title: 小程序带二维码分享图注意点
catalog: true
date: 2021-01-21 17:00:40
subtitle:
header-img:
tags: 小程序
categories: 前端
---

## 前提

目前小程序都是在`Taro`基础上开发

## 注意点

### 获取节点

目前taro上获取canvas节点，有两种方法

1. type + id；
2. canvas-id；
   
两者不能共存

当使用type时，可以通过`createSelectorQuery`方法获取canvas节点获取支持 2D 和 WebGL 绘图上下文的RenderingContext

```javascript
Taro.nextTick(() => {
  const query = Taro.createSelectorQuery()
  query.select('#aniLoading').fields({ node: true, size: true, context: true }).exec(res => {
    if (!res || !res[0]) return
    const canvas = res[0].node;
    const context = canvas.getContext('2d');  
  }) 
})    
```
canvas-id方式可通过Taro.createCanvasContext(canvasId)获取canvas上下文的CanvasContext

```javascript
const ctx = Taro.createCanvasContext(canvasId)
```

由于小程序本身的特性，无法动态创建canvas节点，必须在节点结构提前创建canvas节点

```javascript
 <Canvas
    canvasId='canvas'
    style='width:750px;height:1448px;'
    className='fortune_canvas'
 /> 
```

## 踩坑点

1. 同一页面不能存在相同的canvas-id；
2. <span style="color: red;">canvas元素在Ios真机设备滚动页面下无法上滑；</span>

[![yMg1gJ.md.png](https://s3.ax1x.com/2021/02/03/yMg1gJ.md.png)](https://imgchr.com/i/yMg1gJ)

#### drawImage和base64

canvas内drawImage绘制图片，需要先通过`getImageInfo`或`downloadFile`，将网络图片存到本地之后拿到图片path、宽高等信息来进行绘制

无法直接绘制base64的图，因为base64不是网络地址，就无法通过getImageInfo和downloadFile获取图片信息，可参考官方issue提出的相关问题和解决方案尝试

[小程序生产海报的两种常见方式链接](https://developers.weixin.qq.com/community/develop/article/doc/00008c13228078898f2b0bcf751413)

### 层级

canvas组件层级默认会比普通的view层级高，所以一般无法在canvas组件上再放置其他元素，但如果使用cover-view组件包裹canvas组件，是可以设置层级。

### 二维码

目前采用的是[weapp-qrcode](https://github.com/dillonlfy/weapp-qrcod)来绘制小程序上的二维码，本身也是基于qrcodejs（目前大多数H5上二维码绘制的基础库），测试下来在小程序还是会有一些问题

保存canvas绘制图片时，安卓机器上二维码会比较糊，ios正常，导致wx没法识别，但是在页面绘制的二维码没有此问题

[![yMgnEV.png](https://s3.ax1x.com/2021/02/03/yMgnEV.png)](https://imgchr.com/i/yMgnEV)

目前调试下来，只有在需要绘制保存的图片的二维码时，加上`typeNumber`来进行调节二维码绘制路径的细粒度<span style="color: red;">（正常页面展示时不需要加此参数）</span>

[![yMguNT.png](https://s3.ax1x.com/2021/02/03/yMguNT.png)](https://imgchr.com/i/yMguNT)

```javascript
new QRCode(canvasId, {
  ...
  correctLevel: QRCode.CorrectLevel.M,
  typeNumber: 8
});
```

#### 普通二维码跳转小程序

如果绘制的是普通二维码，需要通过映射二维码地址跳转小程序指定页面   

小程序后台-开发管理-开发设置-扫普通链接二维码打开小程序

[![yMgK4U.md.png](https://s3.ax1x.com/2021/02/03/yMgK4U.md.png)](https://imgchr.com/i/yMgK4U)

需要注意的是二维码映射关系跳转跳转对应的小程序版本（开发、体验、线上版本），测试的地址如果携带参数则必须严格匹配

[![yMgl34.md.png](https://s3.ax1x.com/2021/02/03/yMgl34.md.png)](https://imgchr.com/i/yMgl34)

此方案更多是为了解决线下二维码已经铺设二维码，兼容原先的二维码跳转小程序场景，并不是一个常用的二维码跳转方案。

官方有提供获取小程序码，常规的api每天有数量限制，可以使用如下api，若采用官方生成小程序码的方案，完全可以弃用普通二维码绘制、映射跳转一系列繁琐步骤，但此方案需要依赖后端帮助获取。

[官方不限制获取小程序码](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html)
