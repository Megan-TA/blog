---
title: 性能上报
catalog: true
date: 2020-06-15 17:35:41
subtitle:
header-img:
tags: javascript
categories: 前端
---

性能计算逻辑，全部取自`window.performance.timing`

![指标解读](https://picb.zhimg.com/80/v2-e4e26420d6b681b2b15b9edf9db9d4d0_720w.jpg)

## 关键指标

```javascript
// 上一个页面卸载
unloadEventEnd - unloadEventStart as prevUnload,
// 重定向
redirectEnd - redirectStart as redirect,
// DNS缓存时间
domainLookupStart - fetchStart as appCache,
// DNS解析耗时
domain_lookup_end - domainLookupStart as dns,
// SSL
connectEnd - secureConnectionStart as ssl,
// TCP链接耗时
connectEnd - connectStart as tcp,
// ttfb 页面第一个字节的时间
responseStart - responseStart as ttfb,
// request耗时
responseEnd - responseStart as htmlRequest,
// domLoading - fetchStart as fp,
// dom树解析完成 / 白屏时间  
domInteractive - fetchStart as domIteractive,
// domReady / TTI 可交互时间
domContentLoadEventEnd - fetchStart as domReady,
// dom解析耗时
domComplete -  domLoading as domProcess,
// 资源加载耗时
domComplete - domContentLoadEventStart  as resourceLoad,
// load事件耗时
loadEventEnd - loadEventStart as loadEvent,
// 页面完全加载耗时
loadEventEnd - fetchStart as pageComplete
```

## 首屏时间

首屏时间是指页面第一屏所有资源完整展示的时间。这是一个对用户来说非常直接的体验指标，但是对于前端却是一个非常难以统计衡量的指标。

目前统计首屏时间有如下几种方式：

1. 用户自定义打点（最准确方式，只有用户自己最清楚什么时候算是首屏加载完成）;
2. lighthouse 中使用的是 chrome 渲染过程中记录的 trace event;
3. aegis 的方法：利用 MutationObserver 接口，监听 document 对象的节点变化。

检查这些变化的节点是否在首屏中，若这些节点在首屏中，那当前的时间点就是首屏渲染时间。如果首屏有图片，则通过遍历 performance.getEntries拿到的所有在首屏的图片实体对象，统计最慢的图片加载时间来更新首屏渲染时间；

4. 利用 MutationObserver；

在首屏内容模块插入一个 div，利用 Mutation Observer API 监听该 div 的 dom 事件，判断该 div 的高度是否大于 0 或者大于指定值，如果大于了，就表示主要内容已经渲染出来，可计算首屏时间。

## 数据上报方式

测量好数据之后，需要将数据发给服务端。考虑到页面性能统计对数据的丢失率要求不高，且数据上报应该尽量不影响主流程的逻辑和页面的性能情况下进行。

### img标签上报

标签上报是最通用，最常用的上报方式，其中具备两个主要特点：

1. 没有任何兼容性；
2. 不存在跨域问题；

### navigator.sendBeacon

大部分现代浏览器都支持 navigator.sendBeacon方法。这个方法可以用来发送一些统计和诊断的小量数据，特别适合上报统计的场景。

1. 数据可靠，浏览器关闭也能发送；
2. 异步执行，不会影响下一页面加载即；

```javascript
window.addEventListener('unload', logData, false);

function logData() {
    navigator.sendBeacon("/log", analyticsData);
}
```

## 参考

1. [如何进行web性能监控](http://www.alloyteam.com/2020/01/14184/#prettyPhoto)
